# TRANSMISSION CONTROL PROTOCOL

Before you read, I highly recommend just going through the book yourself. It is highly digestable, even with little networking knowledge.
 
## Operations

Basic Data Transfer
- TCP is able to transfer a continuous stream of octets bth directions by packaging some octets into segments
- TCPs decided when to block or forward data 

Reliablility
- TCP must recover from data that is damaged, lost, duplicated, or delivered out of order
- each octet is assigned a sequence number and requires a postitive acknowledgement (ACK)
- If ACK is not received within timeout, data is retransmitted
- sequence number is used at the receiver to reorganize the packets
- checksum is used to verify the packet integrity

Flow Control
- managed by receiver who returns a "window" with every ACK. The window indicates the number of octets that the sender may transmit before requiring permission

Multiplexing
- allows for many processes within a single host to use TCP communication facilities simultaneously; TCp provides a set of addresses or ports. Network + Host address = Socket which ID's the connection
- binding of ports to processes is handled by each host

Connections
- in order to maintain flow control and reliability, the TCP but initialize status information for each data stream
- to communicate, two processes's TTCP's must establish a connection. When communication is closed or canceled, the resources must be freed

Precedence and Security
- dependant on the users
- default values used if not requsted

## PHILOSOPHY

Model of Operation
- processes call TCP and pass buffers of data as arguments
- TCP packages the data into segments and calls on the internet module to transmit to the destination TCP
- recieving TCP decapsulates the segment and places the data into the receiving user's buffer

The Internet Module
- packages the TCP segments inside of an internet datagram and routes it to the destiation via internet module/intermediate gateway
- if local, the datagram is embedded in a local network packet

Gateways
- at gateways, the datagram can become "unwrapped" from it's local packet to determine which network it needs to travel next, and "re-wrapped" with a local packet suitable to the next network
- gateways can also break up an internet datagram into smaller fragments (the grateway produces a set of internet datagrams, each carry a fragment of the original datagram)
- this process can be done multiple times

Destination Internet Module
- unwraps the segment from the datagram (after reassembiling the fragments if necessary) and passes it to the destination TCP

The Host Environment
- assumed to be in a module in an OS, controlled by a device driver module which the TCP indirectly calls when calling on the internet datagram protocol module

Relations to Other Protocols
- the TCP in the protocol hierarchy
<pre>
 +------+ +-----+ +-----+       +-----+
 |Telnet| | FTP | |Voice|  ...  |     |  Application Level
 +------+ +-----+ +-----+       +-----+
       |   |         |             |
      +-----+     +-----+       +-----+
      | TCP |     | RTP |  ...  |     |  Host Level
      +-----+     +-----+       +-----+
         |           |             |
      +-------------------------------+
      |    Internet Protocol & ICMP   |  Gateway Level
      +-------------------------------+
                     |
        +---------------------------+
        |   Local Network Protocol  |    Network Level
        +---------------------------+
</pre>

Reliable Communication
- made available by sequence numbers and acknowledgements
- first octet of data in a segment is called the segment sequence number
- each segment also indicate which is the sequence number of the next expected data octet of transmission in reverse order
- if TCP transmits a segment containing data, it puts a copy on a retransmission queue and starts a timer, if no acknowledgement is received before the timer runs out, the segment is retransmitted.
- window frame helps govern the flow of data between TCPs

Connection Establishment and Clearing

Unique Identification
- to seperate data streams, the TCP provides a port id, but that is not unique
- to provide for unique addresses within each TCP, the internet address is concatenated with a port id to create a socket

Full Duplex
- connection which is used to carry data in both directions

Port Ownership w Processes
- there are well-known sockets which the TCP associated with "appropriate" processes
- these processes can initiate connections only on the ports they own

Socket Connection
- connection is specificed in the OPEN call by the local port and the foreign socket arguments
- the TCP provides a connection name by which the users can refer to in subsequent calls
- local connection name will be a pointer to a TCB
- the OPEN call also specifies whether the connection establishment is to be actively pursued, or to be passively waited for

Transmission Control Block (TCB)
- data structure which holds the information about a connection

Passive OPEN request
- process wants to accept incoming connection requests rather than attempting to initiate a connection
- a service process that wished to provide services for unknown other processes would issue a passive OPEN request with an unspecified foreign socket

Foreign Sockets
- foreign socket of all zeros is used to denote an unspecified socket
- unspecified foreign sockets are allowed only on **passive OPENs**.

Associating a Socket Address with a Standard Service
- well known sockets are a convenient mechanism for a associating a socket address with a standard service
- "Telnet-Server" rpocess is permanently assigned to a socket and others are reserved for File Transfer, Remote Job Entry, Text Generator, Echoer, and Sink processes
- one might be resevered for a "Look-Up" service to find specific sockets

Active OPEN request
- processes can issue passive OPENs and wait for matching active OPENs from other processes
- two processes which issue active OPENs to eachother at the same time will be connected

Principal Cases for Matching Sockets
1. local passive OPENs has fully specified the foreign socket: match must be exact
2. local passive OPENs has left the foreign socket unspecified: any foreign socket is acceptable as long as the local sockets match
- if several pending passive OPENs are targetting the same local socket, an foreign active OPEN will be matched to a TCB with the specific foreign sockets, if they exist, before selecting a TCB with an unspecified foregin socket

Connection Initiated
- rendezvous of arriving segment with SYN and a waiting TCB entry each created by a user OPEN command
- matching of local and foregin socket determines which a connection has been initiated
- connection becomes "established" which sequence numbers have been synchronized in both directions

Data Communication
- data that flows can be thought of as a stream of octets

PUSH Flag
- determines whether the data sent to a user in a SEND call should be immediately pushed through to the receiving user
- otherwise, a sending TCP is allowed to collect data from the sending user and to send that data in segments at its own convenience
- does not provide a record service

PUSH flag and Buffers
- each time a PUSH flag is associated with data placed into the receiving user's buffer, the buffer is returned to the ser for processing even if the buffer is not filled
- if buffer gets filled before a PUSH, data is passed in buffer size units

Hijacking Communication
- if there is urgent data the TCP provides means to communicate at some point further along in the data stream then the receiver is currently reading

Precedence and Security 
- provided by the internet protocol type of service field and security option

Robustness Principle
- be conservative in what you do, be liberal in what you accept from others

## FUNCTIONAL SPECIFICATION

Header Format
- TCP segments are sent as internet datagrams
<pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |          Source Port          |       Destination Port        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Acknowledgment Number                      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Data |           |U|A|P|R|S|F|                               |
 | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
 |       |           |G|K|H|T|N|N|                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |           Checksum            |         Urgent Pointer        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Options                    |    Padding    |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                             data                              |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                          TCP Header Format
 </pre>
- source port: 16 bits
- destination port: 16 bits
- sequence number: 32 bits (sequence number of the first data octet, unless SYN)
- acknowledgement number: 32 bits (contains values of the next sequence number)
- data offset: 4 bits (indicates where data begins)
- reserved 6 bits (zeros)
- control bits
<pre>
 URG:  Urgent Pointer field significant
 ACK:  Acknowledgment field significant
 PSH:  Push Function
 RST:  Reset the connection
 SYN:  Synchronize sequence numbers
 FIN:  No more data from sender
</pre>
- window: 16 bits
- checksum: 16 bits (one's complement of the one's complement sum of all 16 bit words in the header)
<pre>
 +--------+--------+--------+--------+
 |           Source Address          |
 +--------+--------+--------+--------+
 |         Destination Address       |
 +--------+--------+--------+--------+
 |  zero  |  PTCL  |    TCP Length   |
 +--------+--------+--------+--------+
</pre>
- urgent pointer: 16 bits (indicates the current value as a +ve offest from the sequence number in this segment)
- options: variable
<pre>
Case 1:  A single octet of option-kind.

Case 2:  An octet of option-kind, an octet of option-length, and
         the actual option-data octets.
Currently defined options include (kind indicated in octal):

 Kind     Length    Meaning
 ----     ------    -------
  0         -       End of option list.
  1         -       No-Operation.
  2         4       Maximum Segment Size.
</pre>
- padding: variable (zeros)

Terminology
- variables stored in the TCB
<pre>
 Send Sequence Variables

  SND.UNA - send unacknowledged
  SND.NXT - send next
  SND.WND - send window
  SND.UP  - send urgent pointer
  SND.WL1 - segment sequence number used for last window update
  SND.WL2 - segment acknowledgment number used for last window
            update
  ISS     - initial send sequence number

Receive Sequence Variables

  RCV.NXT - receive next
  RCV.WND - receive window
  RCV.UP  - receive urgent pointer
  IRS     - initial receive sequence number

Current Segment Variables

 SEG.SEQ - segment sequence number
 SEG.ACK - segment acknowledgment number
 SEG.LEN - segment length
 SEG.WND - segment window
 SEG.UP  - segment urgent pointer
 SEG.PRC - segment precedence value
</pre>

Connection Progression through State-Changes
- a TCP connection progresses from one state to another in response to events
- events are user calls: OPEN, SEND, RECEIVE, CLOSE, ABORT, and STATUS, and incoming segments: SYN, ACK, RST, and FIN flags, and timeouts
- LISTEN, SYN-SENT, SYN-RECEIVED, ESTABLISHED, FIN-WAIT-1, FIN-WAIT-2, CLOSE-WAIT, CLOSING. LAST-ACK, TIME-WAIT, and CLOSED (fictional to represent the state where there is no TCB
<pre>
LISTEN - represents waiting for a connection request from any remote
TCP and port.

SYN-SENT - represents waiting for a matching connection request
after having sent a connection request.

SYN-RECEIVED - represents waiting for a confirming connection
request acknowledgment after having both received and sent a
connection request.

ESTABLISHED - represents an open connection, data received can be
delivered to the user.  The normal state for the data transfer phase
of the connection.

FIN-WAIT-1 - represents waiting for a connection termination request
from the remote TCP, or an acknowledgment of the connection
termination request previously sent.

FIN-WAIT-2 - represents waiting for a connection termination request
from the remote TCP.

CLOSE-WAIT - represents waiting for a connection termination request
from the local user.

CLOSING - represents waiting for a connection termination request
acknowledgment from the remote TCP.

LAST-ACK - represents waiting for an acknowledgment of the
connection termination request previously sent to the remote TCP
(which includes an acknowledgment of its connection termination
request).
 
TIME-WAIT - represents waiting for enough time to pass to be sure
the remote TCP received the acknowledgment of its connection
termination request.

CLOSED - represents no connection state at all.
</pre>

State Diagram (Summary)
<pre>
                             +---------+ ---------\      active OPEN
                             |  CLOSED |            \    -----------
                             +---------+<---------\   \   create TCB
                               |     ^              \   \  snd SYN
                  passive OPEN |     |   CLOSE        \   \
                  ------------ |     | ----------       \   \
                   create TCB  |     | delete TCB         \   \
                               V     |                      \   \
                             +---------+            CLOSE    |    \
                             |  LISTEN |          ---------- |     |
                             +---------+          delete TCB |     |
                  rcv SYN      |     |     SEND              |     |
                 -----------   |     |    -------            |     V
+---------+      snd SYN,ACK  /       \   snd SYN          +---------+
|         |<-----------------           ------------------>|         |
|   SYN   |                    rcv SYN                     |   SYN   |
|   RCVD  |<-----------------------------------------------|   SENT  |
|         |                    snd ACK                     |         |
|         |------------------           -------------------|         |
+---------+   rcv ACK of SYN  \       /  rcv SYN,ACK       +---------+
  |           --------------   |     |   -----------
  |                  x         |     |     snd ACK
  |                            V     V
  |  CLOSE                   +---------+
  | -------                  |  ESTAB  |
  | snd FIN                  +---------+
  |                   CLOSE    |     |    rcv FIN
  V                  -------   |     |    -------
+---------+          snd FIN  /       \   snd ACK          +---------+
|  FIN    |<-----------------           ------------------>|  CLOSE  |
| WAIT-1  |------------------                              |   WAIT  |
+---------+          rcv FIN  \                            +---------+
  | rcv ACK of FIN   -------   |                            CLOSE  |
  | --------------   snd ACK   |                           ------- |
  V        x                   V                           snd FIN V
+---------+                  +---------+                   +---------+
|FINWAIT-2|                  | CLOSING |                   | LAST-ACK|
+---------+                  +---------+                   +---------+
  |                rcv ACK of FIN |                 rcv ACK of FIN |
  |  rcv FIN       -------------- |    Timeout=2MSL -------------- |
  |  -------              x       V    ------------        x       V
   \ snd ACK                 +---------+delete TCB         +---------+
    ------------------------>|TIME WAIT|------------------>| CLOSED  |
                             +---------+                   +---------+

                     TCP Connection State Diagram
</pre>

Sequence Numbers
- every octet of data sent over a TCP has a sequence number
- sequence number space is finite (range 0 to 2^23-1) therefore must be % to form a loop with that amount

Sequence Number Comparisons TCP must preform:
1. determining that ack refers to some sequence number sent but not acknowledged
2. determining that all sequence numbers occupied by a segment have been acknowledged (remove the segment from retransmission queue_
3. determining that an incoming segment contains sequence numbers which are expected ("overlaps" the receive window)

New Acknowledgement
- "acceptable ack"
- holds this inequality: SND.UNA < SEG.ACK =< SND.NXT

Retransmission Queue
- a segment is full acknowledged if the sum of its sequence number and the length is less or equal than the acknowledgement value in the incoming segment

                    


